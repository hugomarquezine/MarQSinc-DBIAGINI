<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Sistema Cl√≠nica</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .test-result {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: monospace;
        }
        .test-success { background: #e8f5e8; border: 1px solid #4CAF50; }
        .test-error { background: #ffeaea; border: 1px solid #f44336; }
        .test-warning { background: #fff3e0; border: 1px solid #ff9800; }
        .test-button {
            background: #008080;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.5rem;
        }
        .test-button:hover { background: #006666; }
        .test-button:disabled { background: #ccc; cursor: not-allowed; }
        .navigation {
            text-align: center;
            margin-bottom: 2rem;
        }
        .nav-link {
            display: inline-block;
            margin: 0 1rem;
            padding: 0.75rem 1.5rem;
            background: #008080;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
        }
        .nav-link:hover { background: #006666; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Teste do Sistema Cl√≠nica</h1>
        <p>Este teste verifica se o sistema est√° funcionando corretamente com webhooks.</p>

        <div class="navigation">
            <a href="index.html" class="nav-link">üè† In√≠cio</a>
            <a href="config.html" class="nav-link">‚öôÔ∏è Configura√ß√£o</a>
            <a href="admin.html" class="nav-link">üë®‚Äçüíº Admin</a>
        </div>

        <!-- Teste de Configura√ß√£o -->
        <div class="test-section">
            <h2>1. Teste de Configura√ß√£o</h2>
            <button class="test-button" onclick="testConfig()">Testar Configura√ß√£o</button>
            <div id="config-result"></div>
        </div>

        <!-- Teste de Conectividade -->
        <div class="test-section">
            <h2>2. Teste de Conectividade</h2>
            <button class="test-button" onclick="testConnectivity()">Testar Webhooks</button>
            <div id="connectivity-result"></div>
        </div>

        <!-- Teste de Envio de Dados -->
        <div class="test-section">
            <h2>3. Teste de Envio de Dados</h2>
            <button class="test-button" onclick="testDataSending()">Testar Envio</button>
            <div id="data-result"></div>
        </div>

        <!-- Teste de Fallback -->
        <div class="test-section">
            <h2>4. Teste de Fallback</h2>
            <button class="test-button" onclick="testFallback()">Testar Fallback</button>
            <div id="fallback-result"></div>
        </div>

        <!-- Resumo dos Testes -->
        <div class="test-section">
            <h2>üìä Resumo dos Testes</h2>
            <div id="summary-result"></div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // Vari√°veis para controle dos testes
        const testResults = {};
        
        // Fun√ß√£o para adicionar resultados
        function addResult(containerId, message, type) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.textContent = message;
            container.appendChild(resultDiv);
        }

        // Teste de configura√ß√£o
        async function testConfig() {
            try {
                addResult('config-result', 'üîÑ Testando configura√ß√£o...', 'warning');
                
                const config = window.appConfig.getConfig();
                
                if (!config) {
                    throw new Error('Configura√ß√£o n√£o encontrada');
                }
                
                // Verifica se as URLs dos webhooks est√£o configuradas
                const webhookServices = ['anamnese', 'chat', 'cardapio', 'skincare', 'wishlist', 'areasIncomodo', 'areasInteresse', 'buscarPaciente'];
                const missingWebhooks = webhookServices.filter(service => !config.webhooks[service]);
                
                if (missingWebhooks.length > 0) {
                    throw new Error(`Webhooks n√£o configurados: ${missingWebhooks.join(', ')}`);
                }
                
                testResults.config = true;
                addResult('config-result', '‚úÖ Configura√ß√£o v√°lida', 'success');
                addResult('config-result', `üìã Provedor: ${config.useSupabase ? 'Supabase' : 'Webhook (n8n)'}`, 'success');
                addResult('config-result', `üîÑ Fallback: ${config.fallback.enableFallback ? 'Habilitado' : 'Desabilitado'}`, 'success');
                
            } catch (error) {
                testResults.config = false;
                addResult('config-result', `‚ùå Erro: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        // Teste de conectividade
        async function testConnectivity() {
            try {
                addResult('connectivity-result', 'üîÑ Testando conectividade...', 'warning');
                
                const config = window.appConfig.getConfig();
                const results = [];
                
                for (const [service, url] of Object.entries(config.webhooks)) {
                    if (url) {
                        try {
                            const testData = {
                                test: true,
                                service: service,
                                timestamp: new Date().toISOString()
                            };
                            
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(testData)
                            });
                            
                            if (response.ok) {
                                results.push(`‚úÖ ${service}: OK`);
                            } else {
                                results.push(`‚ùå ${service}: Erro ${response.status}`);
                            }
                        } catch (error) {
                            results.push(`‚ùå ${service}: ${error.message}`);
                        }
                    }
                }
                
                const successCount = results.filter(r => r.includes('‚úÖ')).length;
                const totalCount = results.length;
                
                if (successCount === totalCount) {
                    testResults.connectivity = true;
                    addResult('connectivity-result', '‚úÖ Todos os webhooks funcionando', 'success');
                } else {
                    testResults.connectivity = false;
                    addResult('connectivity-result', `‚ö† ${successCount}/${totalCount} webhooks funcionando`, 'warning');
                }
                
                results.forEach(result => {
                    addResult('connectivity-result', result, result.includes('‚úÖ') ? 'success' : 'error');
                });
                
            } catch (error) {
                testResults.connectivity = false;
                addResult('connectivity-result', `‚ùå Erro: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        // Teste de envio de dados
        async function testDataSending() {
            try {
                addResult('data-result', 'üîÑ Testando envio de dados...', 'warning');
                
                const config = window.appConfig.getConfig();
                const testData = {
                    patientId: 'test-patient-123',
                    clinicId: 'test-clinic-456',
                    timestamp: new Date().toISOString(),
                    test: true
                };
                
                // Testa envio para diferentes servi√ßos
                const services = ['chat', 'skincare', 'wishlist'];
                const results = [];
                
                for (const service of services) {
                    try {
                        const url = config.webhooks[service];
                        if (url) {
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ...testData, service })
                            });
                            
                            if (response.ok) {
                                results.push(`‚úÖ ${service}: Dados enviados`);
                            } else {
                                results.push(`‚ùå ${service}: Erro ${response.status}`);
                            }
                        }
                    } catch (error) {
                        results.push(`‚ùå ${service}: ${error.message}`);
                    }
                }
                
                const successCount = results.filter(r => r.includes('‚úÖ')).length;
                
                if (successCount === results.length) {
                    testResults.dataSending = true;
                    addResult('data-result', '‚úÖ Envio de dados funcionando', 'success');
                } else {
                    testResults.dataSending = false;
                    addResult('data-result', `‚ö† ${successCount}/${results.length} servi√ßos funcionando`, 'warning');
                }
                
                results.forEach(result => {
                    addResult('data-result', result, result.includes('‚úÖ') ? 'success' : 'error');
                });
                
            } catch (error) {
                testResults.dataSending = false;
                addResult('data-result', `‚ùå Erro: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        // Teste de fallback
        async function testFallback() {
            try {
                addResult('fallback-result', 'üîÑ Testando sistema de fallback...', 'warning');
                
                const config = window.appConfig.getConfig();
                
                if (!config.fallback.enableFallback) {
                    testResults.fallback = true;
                    addResult('fallback-result', '‚úÖ Fallback desabilitado (configura√ß√£o correta)', 'success');
                    return;
                }
                
                // Simula falha de webhook
                const testUrl = 'https://webhook-falha-teste.com/invalid';
                const testData = { test: true };
                
                try {
                    await fetch(testUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testData)
                    });
                } catch (error) {
                    // Esperado - webhook deve falhar
                    testResults.fallback = true;
                    addResult('fallback-result', '‚úÖ Sistema de fallback configurado corretamente', 'success');
                    addResult('fallback-result', `üìã Tentativas: ${config.fallback.retryAttempts}`, 'success');
                    addResult('fallback-result', `‚è±Ô∏è Delay: ${config.fallback.retryDelay}ms`, 'success');
                }
                
            } catch (error) {
                testResults.fallback = false;
                addResult('fallback-result', `‚ùå Erro: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        // Atualiza resumo
        function updateSummary() {
            const summaryContainer = document.getElementById('summary-result');
            summaryContainer.innerHTML = '';

            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const failedTests = totalTests - passedTests;

            if (totalTests === 0) {
                addResult('summary-result', 'üîÑ Execute os testes para ver o resumo', 'warning');
                return;
            }

            const summaryDiv = document.createElement('div');
            summaryDiv.className = `test-result ${failedTests === 0 ? 'test-success' : 'test-warning'}`;
            summaryDiv.innerHTML = `
                <strong>Resumo dos Testes:</strong><br>
                ‚úÖ Testes aprovados: ${passedTests}<br>
                ‚ùå Testes falharam: ${failedTests}<br>
                üìä Total: ${totalTests}<br>
                ${failedTests === 0 ? 'üéâ Todos os testes passaram!' : '‚ö† Alguns testes falharam. Verifique os logs acima.'}
            `;
            summaryContainer.appendChild(summaryDiv);
        }

        // Executa todos os testes automaticamente
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                await testConfig();
                await testConnectivity();
                await testDataSending();
                await testFallback();
            }, 1000);
        });
    </script>
</body>
</html>